name: ğŸ—‚ï¸ Gerar Ãndice de PrescriÃ§Ãµes

on:
  push:
    paths:
      - 'js/prescricoes/**'
    branches: [ main, master ]
  workflow_dispatch:  # Permite executar manualmente

jobs:
  gerar-indice:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: ğŸ—ƒï¸ Gerar Ã­ndice de prescriÃ§Ãµes
      id: gerar-indice
      run: |
        echo "ğŸ“ Iniciando geraÃ§Ã£o do Ã­ndice..."
        
        # Cria o script Node.js para gerar o Ã­ndice
        cat > gerar_indice.js << 'EOF'
        const fs = require('fs');
        const path = require('path');

        function gerarIndice() {
            const prescricoesDir = path.join(__dirname, 'js', 'prescricoes');
            console.log(`ğŸ“‚ Escaneando: ${prescricoesDir}`);
            
            const indice = {
                geradoEm: new Date().toISOString(),
                geradoPor: 'GitHub Actions',
                commit: process.env.GITHUB_SHA || 'local',
                arquivos: []
            };

            function scanDirectory(dir, pastaBase = '') {
                if (!fs.existsSync(dir)) {
                    console.log(`âŒ Pasta nÃ£o existe: ${dir}`);
                    return;
                }
                
                const itens = fs.readdirSync(dir);
                console.log(`ğŸ“ Pasta ${pastaBase || 'root'}: ${itens.length} itens`);
                
                itens.forEach(item => {
                    if (item === 'indice.json') return; // Ignora o prÃ³prio Ã­ndice
                    
                    const caminhoCompleto = path.join(dir, item);
                    const stat = fs.statSync(caminhoCompleto);
                    
                    if (stat.isDirectory()) {
                        // Ã‰ uma pasta - scaneia recursivamente
                        scanDirectory(caminhoCompleto, path.join(pastaBase, item));
                    } else if (item.endsWith('.json')) {
                        // Ã‰ um arquivo JSON - adiciona ao Ã­ndice
                        const caminhoRelativo = path.join(pastaBase, item);
                        try {
                            const dados = JSON.parse(fs.readFileSync(caminhoCompleto, 'utf8'));
                            indice.arquivos.push({
                                caminho: caminhoRelativo.replace(/\\/g, '/'),
                                id: dados.id,
                                nome: dados.nome,
                                categoria: dados.categoria,
                                faixa: dados.faixa,
                                tipo: dados.tipo
                            });
                            console.log(`âœ… ${caminhoRelativo}`);
                        } catch (e) {
                            console.log(`âŒ Erro em ${caminhoRelativo}: ${e.message}`);
                        }
                    }
                });
            }

            scanDirectory(prescricoesDir);
            indice.totalArquivos = indice.arquivos.length;
            
            // EstatÃ­sticas
            const categorias = [...new Set(indice.arquivos.map(a => a.categoria))];
            const faixas = [...new Set(indice.arquivos.map(a => a.faixa))];
            const tipos = [...new Set(indice.arquivos.map(a => a.tipo))];
            
            console.log('\nğŸ“Š ESTATÃSTICAS:');
            console.log(`ğŸ“„ Total de arquivos: ${indice.totalArquivos}`);
            console.log(`ğŸ“‚ Categorias: ${categorias.join(', ')}`);
            console.log(`ğŸ‘¥ Faixas etÃ¡rias: ${faixas.join(', ')}`);
            console.log(`ğŸ¥ Tipos: ${tipos.join(', ')}`);

            // Salva o Ã­ndice
            const indicePath = path.join(prescricoesDir, 'indice.json');
            fs.writeFileSync(indicePath, JSON.stringify(indice, null, 2));
            console.log(`\nğŸ’¾ Ãndice salvo em: ${indicePath}`);
            
            return indice;
        }

        const resultado = gerarIndice();
        console.log(`\nğŸ‰ Ãndice gerado com sucesso! ${resultado.totalArquivos} prescriÃ§Ãµes indexadas.`);
        EOF

        # Executa o script
        node gerar_indice.js

    - name: ğŸ’¾ Commit do Ã­ndice gerado
      if: always()
      run: |
        echo "ğŸ“¦ Verificando mudanÃ§as no Ã­ndice..."
        
        if git diff --name-only | grep -q "js/prescricoes/indice.json"; then
          echo "ğŸ”„ Ãndice modificado - fazendo commit..."
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add js/prescricoes/indice.json
          git commit -m "ğŸ—‚ï¸ Atualizar Ã­ndice de prescriÃ§Ãµes [bot]"
          git push
          echo "âœ… Commit realizado!"
        else
          echo "â„¹ï¸  Nenhuma mudanÃ§a no Ã­ndice"
        fi

    - name: ğŸ“ Resumo do workflow
      if: always()
      run: |
        echo "ğŸ‰ WORKFLOW CONCLUÃDO"
        echo "===================="
        echo "O Ã­ndice de prescriÃ§Ãµes foi atualizado automaticamente"
        echo "PrÃ³ximos arquivos adicionados em js/prescricoes/ serÃ£o detectados automaticamente"
